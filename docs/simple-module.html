<!DOCTYPE html>

<html>
<head>
  <title>simple-module.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="all.html">
                  all.lisp
                </a>
              
                
                <a class="source" href="base.html">
                  base.lisp
                </a>
              
                
                <a class="source" href="compile-to-file.html">
                  compile-to-file.lisp
                </a>
              
                
                <a class="source" href="file-package.html">
                  file-package.lisp
                </a>
              
                
                <a class="source" href="hash-lang.html">
                  hash-lang.lisp
                </a>
              
                
                <a class="source" href="hash-table-module.html">
                  hash-table-module.lisp
                </a>
              
                
                <a class="source" href="http.html">
                  http.lisp
                </a>
              
                
                <a class="source" href="impl.html">
                  impl.lisp
                </a>
              
                
                <a class="source" href="makefile.html">
                  makefile.lisp
                </a>
              
                
                <a class="source" href="module.html">
                  module.lisp
                </a>
              
                
                <a class="source" href="parsers.html">
                  parsers.lisp
                </a>
              
                
                <a class="source" href="safer-read.html">
                  safer-read.lisp
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.lisp
                </a>
              
                
                <a class="source" href="shadows.html">
                  shadows.lisp
                </a>
              
                
                <a class="source" href="similarity.html">
                  similarity.lisp
                </a>
              
                
                <a class="source" href="simple-module.html">
                  simple-module.lisp
                </a>
              
                
                <a class="source" href="specials.html">
                  specials.lisp
                </a>
              
                
                <a class="source" href="types.html">
                  types.lisp
                </a>
              
                
                <a class="source" href="universal.html">
                  universal.lisp
                </a>
              
                
                <a class="source" href="util.html">
                  util.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>simple-module.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">uiop</span><span class="hljs-symbol">:define-package</span> <span class="hljs-symbol">:overlord/simple-module</span>
    (<span class="hljs-symbol">:use</span>)
  (<span class="hljs-symbol">:mix</span> <span class="hljs-symbol">:serapeum</span> <span class="hljs-symbol">:alexandria</span> <span class="hljs-symbol">:overlord/shadows</span> <span class="hljs-symbol">:overlord/types</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:alexandria</span> <span class="hljs-symbol">:mappend</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:serapeum</span> <span class="hljs-symbol">:op</span> <span class="hljs-symbol">:car-safe</span> <span class="hljs-symbol">:keep</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/module</span> <span class="hljs-symbol">:module-ref</span> <span class="hljs-symbol">:module-ref*</span> <span class="hljs-symbol">:module-exports</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/parsers</span> <span class="hljs-symbol">:slurp-stream</span> <span class="hljs-symbol">:slurp-file</span>)
  (<span class="hljs-symbol">:export</span>
   <span class="hljs-symbol">:read-module</span> <span class="hljs-symbol">:module-progn</span>
   <span class="hljs-symbol">:simple-module</span>
   <span class="hljs-symbol">:static-exports</span>))
(<span class="hljs-name">in-package</span> <span class="hljs-symbol">:overlord/simple-module</span>)

(<span class="hljs-name">defun</span> read-module (<span class="hljs-name">source</span> stream)
  (<span class="hljs-name">declare</span> (<span class="hljs-name">ignore</span> source))
  `(module-progn
     ,@(slurp-stream stream)))

(<span class="hljs-name">defmacro</span> module-progn (<span class="hljs-name">&amp;body</span> body)
  (<span class="hljs-name">let*</span> ((<span class="hljs-name">export-forms</span> (<span class="hljs-name">keep</span> <span class="hljs-symbol">:export</span> body <span class="hljs-symbol">:key</span> #'car-safe))
         (<span class="hljs-name">exports</span> (<span class="hljs-name">mappend</span> #'rest export-forms))
         (<span class="hljs-name">body</span> (<span class="hljs-name">remove-if</span> (<span class="hljs-name">op</span> (<span class="hljs-name">member</span> _ export-forms)) body)))
    `(simple-module ,exports
       ,@body)))

(<span class="hljs-name">defun</span> static-exports (<span class="hljs-name">source</span>)
  (<span class="hljs-name">let*</span> ((<span class="hljs-name">forms</span> (<span class="hljs-name">slurp-file</span> source))
         (<span class="hljs-name">export-forms</span> (<span class="hljs-name">keep</span> <span class="hljs-symbol">:export</span> forms <span class="hljs-symbol">:key</span> #'car))
         (<span class="hljs-name">exports</span> (<span class="hljs-name">mappend</span> #'rest export-forms)))
    (<span class="hljs-name">loop</span> for export in exports
          if (<span class="hljs-name">listp</span> export)
            collect (<span class="hljs-name">second</span> export)
          else collect export)))



(<span class="hljs-name">defun</span> export-keyword (<span class="hljs-name">spec</span>)
  (<span class="hljs-name">assure</span> keyword
    (<span class="hljs-name">etypecase-of</span> export-spec spec
      (<span class="hljs-name">non-keyword</span> (<span class="hljs-name">make-keyword</span> spec))
      (<span class="hljs-name">function-spec</span> (<span class="hljs-name">export-keyword</span> (<span class="hljs-name">second</span> spec)))
      ((<span class="hljs-name">or</span> (<span class="hljs-name">tuple</span> non-keyword export-alias)
           (<span class="hljs-name">tuple</span> function-spec export-alias))
       (<span class="hljs-name">make-keyword</span> (<span class="hljs-name">second</span> spec)))
      ((<span class="hljs-name">or</span> macro-spec (<span class="hljs-name">tuple</span> macro-spec export-alias))
       (<span class="hljs-name">error</span> <span class="hljs-string">"Simple modules cannot export macros."</span>)))))

(<span class="hljs-name">defun</span> export-binding (<span class="hljs-name">spec</span>)
  (<span class="hljs-name">assure</span> (<span class="hljs-name">or</span> non-keyword function-spec)
    (<span class="hljs-name">etypecase-of</span> export-spec spec
      (<span class="hljs-name">non-keyword</span> spec)
      (<span class="hljs-name">function-spec</span> spec)
      ((<span class="hljs-name">tuple</span> non-keyword export-alias) (<span class="hljs-name">first</span> spec))
      ((<span class="hljs-name">tuple</span> function-spec export-alias) (<span class="hljs-name">first</span> spec))
      ((<span class="hljs-name">or</span> macro-spec (<span class="hljs-name">tuple</span> macro-spec export-alias))
       (<span class="hljs-name">error</span> <span class="hljs-string">"Simple modules cannot export macros."</span>)))))

(<span class="hljs-name">defstruct-read-only</span> (<span class="hljs-name">simple-module</span> (<span class="hljs-symbol">:conc-name</span> sm.))
  (<span class="hljs-name">thunk</span> <span class="hljs-symbol">:type</span> function))

(<span class="hljs-name">defmethod</span> print-object ((<span class="hljs-name">self</span> simple-module) stream)
  (<span class="hljs-name">print-unreadable-object</span> (<span class="hljs-name">self</span> stream <span class="hljs-symbol">:type</span> <span class="hljs-literal">t</span>)))

(<span class="hljs-name">def</span> list-exports '%list-exports)

(<span class="hljs-name">defmethod</span> module-ref ((<span class="hljs-name">sm</span> simple-module) (<span class="hljs-name">key</span> symbol))
  (<span class="hljs-name">funcall</span> (<span class="hljs-name">sm</span>.thunk sm) key))

(<span class="hljs-name">defmethod</span> module-exports ((<span class="hljs-name">sm</span> simple-module))
  (<span class="hljs-name">module-ref*</span> sm list-exports))

(<span class="hljs-name">defmacro</span> simple-module ((<span class="hljs-name">&amp;rest</span> exports) <span class="hljs-symbol">&amp;body</span> body)
  `(make-simple-module
    <span class="hljs-symbol">:thunk</span>
    (mlet ,exports
      ,@body)))

(<span class="hljs-name">defmacro</span> mlet (<span class="hljs-name">exports</span> <span class="hljs-symbol">&amp;body</span> body)
  `(local*
     ,@body</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>; The name for the lambda is just to make debugging easier.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>     (named-lambda ,(string-gensym 'simple-module) (key)
       ,(mlet-get exports 'key))))

(defun mlet-get (exports key)
  (let* ((export-keys (mapcar #'export-keyword exports))
         (export-bindings (mapcar #'export-binding exports)))</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>; No duplicate exports.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (assert (length= export-keys (nub export-keys)))
    `(ecase ,key
       (,list-exports ',export-keys)
       ,@(mapcar #'list export-keys export-bindings))))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
