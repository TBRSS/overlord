<!DOCTYPE html>

<html>
<head>
  <title>util.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="all.html">
                  all.lisp
                </a>
              
                
                <a class="source" href="base.html">
                  base.lisp
                </a>
              
                
                <a class="source" href="compile-to-file.html">
                  compile-to-file.lisp
                </a>
              
                
                <a class="source" href="file-package.html">
                  file-package.lisp
                </a>
              
                
                <a class="source" href="hash-lang.html">
                  hash-lang.lisp
                </a>
              
                
                <a class="source" href="hash-table-module.html">
                  hash-table-module.lisp
                </a>
              
                
                <a class="source" href="http.html">
                  http.lisp
                </a>
              
                
                <a class="source" href="impl.html">
                  impl.lisp
                </a>
              
                
                <a class="source" href="makefile.html">
                  makefile.lisp
                </a>
              
                
                <a class="source" href="module.html">
                  module.lisp
                </a>
              
                
                <a class="source" href="parsers.html">
                  parsers.lisp
                </a>
              
                
                <a class="source" href="safer-read.html">
                  safer-read.lisp
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.lisp
                </a>
              
                
                <a class="source" href="shadows.html">
                  shadows.lisp
                </a>
              
                
                <a class="source" href="similarity.html">
                  similarity.lisp
                </a>
              
                
                <a class="source" href="simple-module.html">
                  simple-module.lisp
                </a>
              
                
                <a class="source" href="specials.html">
                  specials.lisp
                </a>
              
                
                <a class="source" href="types.html">
                  types.lisp
                </a>
              
                
                <a class="source" href="universal.html">
                  universal.lisp
                </a>
              
                
                <a class="source" href="util.html">
                  util.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>util.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">cl</span><span class="hljs-symbol">:defpackage</span> #<span class="hljs-symbol">:overlord/util</span>
  (<span class="hljs-symbol">:use</span> <span class="hljs-symbol">:cl</span> <span class="hljs-symbol">:alexandria</span> <span class="hljs-symbol">:serapeum</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/specials</span> <span class="hljs-symbol">:*base*</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/types</span> <span class="hljs-symbol">:case-mode</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:uiop</span>
    <span class="hljs-symbol">:pathname-directory-pathname</span>
    <span class="hljs-symbol">:pathname-parent-directory-pathname</span>
    <span class="hljs-symbol">:file-exists-p</span>
    <span class="hljs-symbol">:run-program</span>
    <span class="hljs-symbol">:native-namestring</span>)
  (<span class="hljs-symbol">:export</span>
   #<span class="hljs-symbol">:package-exports</span>
   #<span class="hljs-symbol">:locate-dominating-file</span>
   #<span class="hljs-symbol">:quoted-symbol</span>?
   #<span class="hljs-symbol">:class-name-of</span>
   #<span class="hljs-symbol">:sh</span>
   #<span class="hljs-symbol">:run-program-in-directory</span>
   #<span class="hljs-symbol">:once</span>
   #<span class="hljs-symbol">:mv-once</span>
   #<span class="hljs-symbol">:package-name-keyword</span> <span class="hljs-symbol">:find-sym</span>
   #<span class="hljs-symbol">:find-external-symbol</span>
   #<span class="hljs-symbol">:pathnamef</span>
   #<span class="hljs-symbol">:coerce-case</span>
   #<span class="hljs-symbol">:eval*</span>
   #<span class="hljs-symbol">:dx-sxhash</span>))
(<span class="hljs-name">cl</span><span class="hljs-symbol">:in-package</span> #<span class="hljs-symbol">:overlord/util</span>)

(<span class="hljs-name">defun</span> package-exports (<span class="hljs-name">p</span>)
  (<span class="hljs-name">collecting</span>
    (<span class="hljs-name">do-external-symbols</span> (<span class="hljs-name">s</span> p)
      (<span class="hljs-name">collect</span> s))))

(<span class="hljs-name">defun</span> locate-dominating-file (<span class="hljs-name">file</span> name)
  (<span class="hljs-name">nlet</span> rec ((<span class="hljs-name">dir</span> (<span class="hljs-name">pathname-directory-pathname</span> file))
             (<span class="hljs-name">name</span> (<span class="hljs-name">pathname</span> name)))
    (<span class="hljs-name">if</span> (<span class="hljs-name">equal</span> dir (<span class="hljs-name">user-homedir-pathname</span>))
        <span class="hljs-literal">nil</span>
        (<span class="hljs-name">let</span> ((<span class="hljs-name">file</span> (<span class="hljs-name">make-pathname</span> <span class="hljs-symbol">:defaults</span> dir
                                   <span class="hljs-symbol">:name</span> (<span class="hljs-name">pathname-name</span> name)
                                   <span class="hljs-symbol">:type</span> (<span class="hljs-name">pathname-type</span> name))))
          (<span class="hljs-name">flet</span> ((<span class="hljs-name">rec</span> ()
                   (<span class="hljs-name">let</span> ((<span class="hljs-name">parent</span> (<span class="hljs-name">pathname-parent-directory-pathname</span> dir)))
                     (<span class="hljs-name">if</span> (<span class="hljs-name">equal</span> parent dir)
                         <span class="hljs-literal">nil</span>
                         (<span class="hljs-name">rec</span> parent name)))))
            (<span class="hljs-name">if</span> (<span class="hljs-name">wild-pathname-p</span> file)
                (<span class="hljs-name">let</span> ((<span class="hljs-name">matches</span> (<span class="hljs-name">directory</span> file)))
                  (<span class="hljs-name">if</span> matches
                      (<span class="hljs-name">values</span> (<span class="hljs-name">first</span> matches) (<span class="hljs-name">rest</span> matches))
                      (<span class="hljs-name">rec</span>)))
                (<span class="hljs-name">or</span> (<span class="hljs-name">file-exists-p</span> file)
                    (<span class="hljs-name">rec</span>))))))))

(<span class="hljs-name">defun</span> quoted-symbol? (<span class="hljs-name">x</span>)
  (<span class="hljs-name">and</span> (<span class="hljs-name">consp</span> x)
       (<span class="hljs-name">=</span> (<span class="hljs-name">length</span> x) <span class="hljs-number">2</span>)
       (<span class="hljs-name">eql</span> (<span class="hljs-name">first</span> x) 'quote)
       (<span class="hljs-name">symbolp</span> (<span class="hljs-name">second</span> x))))

(<span class="hljs-name">defsubst</span> class-name-of (<span class="hljs-name">x</span>)
  (<span class="hljs-name">class-name</span> (<span class="hljs-name">class-of</span> x)))

(<span class="hljs-name">defun</span> sh (<span class="hljs-name">cmd</span> <span class="hljs-symbol">&amp;rest</span> args)
  (<span class="hljs-name">uiop</span><span class="hljs-symbol">:run-program</span>
   (<span class="hljs-name">print</span>
    (<span class="hljs-name">format</span> <span class="hljs-literal">nil</span>
            <span class="hljs-string">"cd ~a; ~?"</span>
            (<span class="hljs-name">pathname-directory-pathname</span> *base*)
            cmd args))))

(<span class="hljs-name">define-compiler-macro</span> sh (<span class="hljs-name">&amp;whole</span> call control-string <span class="hljs-symbol">&amp;rest</span> args)
  (<span class="hljs-name">if</span> (<span class="hljs-name">stringp</span> control-string)
      `(sh (formatter ,control-string) ,@args)
      call))

(<span class="hljs-name">defun</span> run-program-in-directory (<span class="hljs-name">dir</span> program <span class="hljs-symbol">&amp;rest</span> args)
  (<span class="hljs-name">apply</span> #'uiop<span class="hljs-symbol">:run-program</span>
         (<span class="hljs-name">fmt</span> <span class="hljs-string">"cd ~a; ~a"</span>
              (<span class="hljs-name">uiop</span><span class="hljs-symbol">:native-namestring</span> dir)
              (<span class="hljs-name">assure</span> string program))
         <span class="hljs-symbol">:force-shell</span> <span class="hljs-literal">t</span>
         args))

(<span class="hljs-name">defmacro</span> once (<span class="hljs-name">expr</span>)
  <span class="hljs-string">"Evaluate EXPR exactly once and store the result for future calls.

This works by allocating a cell using `load-time-value'. At run time,
we check if the cell has been set. If the cell has been set, then we
return the value stored in the cell. If the cell has not been set,
then we set its value inside a critical section."</span>
  (<span class="hljs-name">with-unique-names</span> (<span class="hljs-name">cell</span> value)
    (<span class="hljs-name">let</span> ((<span class="hljs-name">empty</span> <span class="hljs-string">"empty"</span>))
      `(let* ((,cell (load-time-value (box ,empty)))
              (,value (unbox ,cell)))
         (if (eq ,value ,empty)         ;Identity.
             (synchronized ()</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>; “Double-checked locking.”</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>               (let ((,value (unbox ,cell)))
                 (if (eq ,value ,empty)
                     (setf (unbox ,cell) ,expr)
                     ,value)))</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>; The value has been set, just return it.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>             ,value)))))

(defmacro mv-once (expr)
  `(values-list (once (multiple-value-list ,expr))))

(defun package-name-keyword (x)
  (assure keyword
    (etypecase-of (or package string-designator) x
      (package (make-keyword (package-name x)))
      (keyword x)
      ((or string character symbol) (make-keyword x)))))

(defun find-sym (name package)
  (find-symbol (string name) package))

(defun find-external-symbol (name package)
  (multiple-value-bind (sym status)
      (find-symbol (string name) package)
    (and sym (eql status :external) sym)))

(define-modify-macro pathnamef () pathname
  "Ensure a pathname")

(defun coerce-case (string &amp;key (readtable *readtable*))
  (if (stringp string)
      (ecase-of case-mode (readtable-case readtable)
        (:upcase (string-upcase string))
        (:downcase (string-downcase string))
        (:preserve string)
        (:invert (string-invert-case string)))
      (string string)))

(defun eval* (expr)
  "Evaluate EXPR by compiling it to a thunk, then calling that thunk."
  (funcall (compile nil (eval `(lambda () ,expr)))))

(defmacro dx-sxhash (expr)
  "Like SXHASH, but try to stack-allocate EXPR."
  (with-unique-names (temp)
    `(let ((,temp ,expr))
       (declare (dynamic-extent ,temp))
       (sxhash ,temp))))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
