<!DOCTYPE html>

<html>
<head>
  <title>similarity.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="all.html">
                  all.lisp
                </a>
              
                
                <a class="source" href="base.html">
                  base.lisp
                </a>
              
                
                <a class="source" href="compile-to-file.html">
                  compile-to-file.lisp
                </a>
              
                
                <a class="source" href="file-package.html">
                  file-package.lisp
                </a>
              
                
                <a class="source" href="hash-lang.html">
                  hash-lang.lisp
                </a>
              
                
                <a class="source" href="hash-table-module.html">
                  hash-table-module.lisp
                </a>
              
                
                <a class="source" href="http.html">
                  http.lisp
                </a>
              
                
                <a class="source" href="impl.html">
                  impl.lisp
                </a>
              
                
                <a class="source" href="makefile.html">
                  makefile.lisp
                </a>
              
                
                <a class="source" href="module.html">
                  module.lisp
                </a>
              
                
                <a class="source" href="parsers.html">
                  parsers.lisp
                </a>
              
                
                <a class="source" href="safer-read.html">
                  safer-read.lisp
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.lisp
                </a>
              
                
                <a class="source" href="shadows.html">
                  shadows.lisp
                </a>
              
                
                <a class="source" href="similarity.html">
                  similarity.lisp
                </a>
              
                
                <a class="source" href="simple-module.html">
                  simple-module.lisp
                </a>
              
                
                <a class="source" href="specials.html">
                  specials.lisp
                </a>
              
                
                <a class="source" href="types.html">
                  types.lisp
                </a>
              
                
                <a class="source" href="universal.html">
                  universal.lisp
                </a>
              
                
                <a class="source" href="util.html">
                  util.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>similarity.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">defpackage</span> #<span class="hljs-symbol">:overlord/similarity</span>
  (<span class="hljs-symbol">:use</span> #<span class="hljs-symbol">:cl</span> #<span class="hljs-symbol">:alexandria</span> #<span class="hljs-symbol">:serapeum</span>)
  (<span class="hljs-symbol">:export</span> #<span class="hljs-symbol">:similar</span>?)
  (<span class="hljs-symbol">:documentation</span> <span class="hljs-string">"Implementation of the algorithm from 3.2.4.2.2 for
  determining whether objects are similar."</span>))

(<span class="hljs-name">in-package</span> #<span class="hljs-symbol">:overlord/similarity</span>)

(<span class="hljs-name">define-do-macro</span> do-hash ((<span class="hljs-name">k</span> v ht <span class="hljs-symbol">&amp;optional</span> return) <span class="hljs-symbol">&amp;body</span> body)
  `(maphash (lambda (,k ,v)
              ,@body)
            ,ht))

(<span class="hljs-name">defun</span> flatten-array (<span class="hljs-name">s</span>)
  (<span class="hljs-name">make-array</span> (<span class="hljs-name">array-total-size</span> s)
              <span class="hljs-symbol">:displaced-to</span> s))

(<span class="hljs-name">defun</span> literally-similar? (<span class="hljs-name">s</span> c)
  (<span class="hljs-name">handler-case</span>
      (<span class="hljs-name">equal</span> (<span class="hljs-name">write-to-string</span> s <span class="hljs-symbol">:readably</span> <span class="hljs-literal">t</span>)
             (<span class="hljs-name">write-to-string</span> c <span class="hljs-symbol">:readably</span> <span class="hljs-literal">t</span>))
    (<span class="hljs-name">print-not-readable</span> () <span class="hljs-literal">nil</span>)))

(<span class="hljs-name">defun</span> load-forms-similar? (<span class="hljs-name">s</span> c <span class="hljs-symbol">&amp;optional</span> env)
  (<span class="hljs-name">or</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>; SBCLâ€™s backquote implementation necessitates this.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>   (and (typep s 'structure-object)
        (typep c 'structure-object)
        (literally-similar? s c))
   (handler-case
       (mvlet ((load1 init1 (make-load-form s env))
               (load2 init2 (make-load-form c env)))
         (and (similar? load1 load2)
              (similar? init1 init2)))
     (error () nil))))

(defun same-type? (x y)
  (type= (type-of x)
         (type-of y)))

(defgeneric similar? (s c)
  (:documentation "Are S and C similar according to the definition in CLHS 3.2.4.2.2?")</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>; Default method.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  (<span class="hljs-symbol">:method</span> ((<span class="hljs-name">s</span> <span class="hljs-literal">t</span>) (<span class="hljs-name">c</span> <span class="hljs-literal">t</span>))
    <span class="hljs-literal">nil</span>)
  (<span class="hljs-symbol">:method</span> ((<span class="hljs-name">s</span> number) (<span class="hljs-name">c</span> number))</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>; Two numbers S and C are similar if they are of the same
; type and represent the same mathematical value.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (and (same-type? s c)
         (= s c)))
  (:method ((s character) (c character))</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>; Two simple characters S and C are similar if they have similar
; code attributes.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    (= (char-code s) (char-code c)))
  (:method ((s symbol) (c symbol))
    (let ((p1 (symbol-package s))
          (p2 (symbol-package c)))
      (cond</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>; Two apparently uninterned symbols S and C are similar if
; their names are similar.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>        ((nor p1 p2) (string= s c))
        ((and p1 p2) (eql s c))
        (t nil))))
  (:method ((s package) (c package))
    (similar? (package-name s) (package-name c)))
  (:method ((s random-state) (c random-state))
    (if (subtypep 'random-state 'structure-object)
        (equalp s c)
        (or</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>; On Clozure, for example, random-state is not a subtype of
; structure-object, but it still gets special handling from
; equalp.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>         (<span class="hljs-name">equalp</span> s c)</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>; Everything I can easily test. I also test MCKL, but it
; doesnâ€™t extend equalp.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>         #-(or sbcl ccl clisp ecl gcl)
         (literally-similar? s c))))
  (:method ((s cons) (c cons))
    (and (similar? (car s) (car c))
         (similar? (cdr s) (cdr c))))
  (:method ((s array) (c array))
    (if (and (= (array-rank s) 1)
             (= (array-rank c) 1))
        (and (similar? (length s) (length c))
             (similar? (array-element-type s)
                       (array-element-type c))
             (every #'similar? s c))
        (and (similar? (array-rank s)
                       (array-rank c))
             (similar? (array-dimensions s)
                       (array-dimensions c))
             (similar? (array-element-type s)
                       (array-element-type c))
             (every #'similar?
                    (flatten-array s)
                    (flatten-array c)))))
  (:method ((s hash-table) (c hash-table))
    (and (eql (hash-table-test s)
              (hash-table-test c))
         (flet ((hash-subset? (x y)
                  (do-hash (k1 v1 x t)
                    (multiple-value-bind (v2 v2?)
                        (gethash k1 y)
                      (unless (and v2? (similar? v1 v2))
                        (return nil))))))
           (and (hash-subset? s c)
                (hash-subset? c s)))))
  (:method ((s pathname) (c pathname))
    (equal s c))
  (:method ((s standard-object) (c standard-object))
    (load-forms-similar? s c))
  (:method ((s structure-object) (c structure-object))
    (load-forms-similar? s c)))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
