<!DOCTYPE html>

<html>
<head>
  <title>shadows.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="all.html">
                  all.lisp
                </a>
              
                
                <a class="source" href="base.html">
                  base.lisp
                </a>
              
                
                <a class="source" href="compile-to-file.html">
                  compile-to-file.lisp
                </a>
              
                
                <a class="source" href="file-package.html">
                  file-package.lisp
                </a>
              
                
                <a class="source" href="hash-lang.html">
                  hash-lang.lisp
                </a>
              
                
                <a class="source" href="hash-table-module.html">
                  hash-table-module.lisp
                </a>
              
                
                <a class="source" href="http.html">
                  http.lisp
                </a>
              
                
                <a class="source" href="impl.html">
                  impl.lisp
                </a>
              
                
                <a class="source" href="makefile.html">
                  makefile.lisp
                </a>
              
                
                <a class="source" href="module.html">
                  module.lisp
                </a>
              
                
                <a class="source" href="parsers.html">
                  parsers.lisp
                </a>
              
                
                <a class="source" href="safer-read.html">
                  safer-read.lisp
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.lisp
                </a>
              
                
                <a class="source" href="shadows.html">
                  shadows.lisp
                </a>
              
                
                <a class="source" href="similarity.html">
                  similarity.lisp
                </a>
              
                
                <a class="source" href="simple-module.html">
                  simple-module.lisp
                </a>
              
                
                <a class="source" href="specials.html">
                  specials.lisp
                </a>
              
                
                <a class="source" href="types.html">
                  types.lisp
                </a>
              
                
                <a class="source" href="universal.html">
                  universal.lisp
                </a>
              
                
                <a class="source" href="util.html">
                  util.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>shadows.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">uiop</span><span class="hljs-symbol">:define-package</span> <span class="hljs-symbol">:overlord/shadows</span>
    (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:alexandria</span>)
  (<span class="hljs-symbol">:shadow</span>
   #<span class="hljs-symbol">:module-progn</span>

   #<span class="hljs-symbol">:defun</span>
   #<span class="hljs-symbol">:defmacro</span>
   #<span class="hljs-symbol">:defconstant</span>
   #<span class="hljs-symbol">:define-symbol-macro</span>
   #<span class="hljs-symbol">:def</span> #<span class="hljs-symbol">:define-values</span> #<span class="hljs-symbol">:defconst</span>     <span class="hljs-comment">;Serapeum.</span>
   #<span class="hljs-symbol">:defsubst</span> #<span class="hljs-symbol">:defalias</span>
   #<span class="hljs-symbol">:define-constant</span>                    <span class="hljs-comment">;Alexandria.</span>


   #<span class="hljs-symbol">:let</span>
   #<span class="hljs-symbol">:let*</span>
   #<span class="hljs-symbol">:flet</span>
   #<span class="hljs-symbol">:labels</span>
   #<span class="hljs-symbol">:macrolet</span>
   #<span class="hljs-symbol">:symbol-macrolet</span>

   #<span class="hljs-symbol">:progn</span>
   #<span class="hljs-symbol">:locally</span>
   #<span class="hljs-symbol">:lambda</span>

   #<span class="hljs-symbol">:cons</span>
   #<span class="hljs-symbol">:car</span>
   #<span class="hljs-symbol">:cdr</span>
   #<span class="hljs-symbol">:first</span>
   #<span class="hljs-symbol">:rest</span>
   #<span class="hljs-symbol">:list</span>
   #<span class="hljs-symbol">:list*</span>

   #<span class="hljs-symbol">:eval</span>
   #<span class="hljs-symbol">:apply</span>
   #<span class="hljs-symbol">:funcall</span>)
  (<span class="hljs-symbol">:export</span>
   <span class="hljs-symbol">:def</span> <span class="hljs-symbol">:define-values</span>
   <span class="hljs-symbol">:defalias</span> <span class="hljs-symbol">:defsubst</span>
   <span class="hljs-symbol">:defconst</span> <span class="hljs-symbol">:define-constant</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:serapeum</span> <span class="hljs-symbol">:batches</span> <span class="hljs-symbol">:mapply</span>)
  (<span class="hljs-symbol">:use-reexport</span> <span class="hljs-symbol">:cl</span>)
  (<span class="hljs-symbol">:documentation</span> <span class="hljs-string">"Just like CL, except that some forms are shadowed
  so they can be rebound."</span>))

(<span class="hljs-name">in-package</span> <span class="hljs-symbol">:overlord/shadows</span>)

(<span class="hljs-name">cl</span><span class="hljs-symbol">:defmacro</span> defmacro (<span class="hljs-name">name</span> args <span class="hljs-symbol">&amp;body</span> body)
  `(cl<span class="hljs-symbol">:defmacro</span> ,name ,args ,@body))

(<span class="hljs-name">defmacro</span> progn (<span class="hljs-name">&amp;body</span> body)
  `(cl<span class="hljs-symbol">:progn</span> ,@body))

(<span class="hljs-name">defmacro</span> locally (<span class="hljs-name">&amp;body</span> body)
  `(cl<span class="hljs-symbol">:locally</span> ,@body))

(<span class="hljs-name">defmacro</span> lambda (<span class="hljs-name">args</span> <span class="hljs-symbol">&amp;body</span> body)
  `(cl<span class="hljs-symbol">:lambda</span> ,args ,@body))

(<span class="hljs-name">cl</span><span class="hljs-symbol">:macrolet</span> ((<span class="hljs-name">binder</span> (<span class="hljs-name">ours</span> theirs)
                (<span class="hljs-name">assert</span> (<span class="hljs-name">not</span> (<span class="hljs-name">eql</span> ours theirs)))
                `(defmacro ,ours (binds &amp;body body)
                   (cl:list* ',theirs binds body))))
  (<span class="hljs-name">binder</span> let cl<span class="hljs-symbol">:let</span>)
  (<span class="hljs-name">binder</span> let* cl<span class="hljs-symbol">:let*</span>)
  (<span class="hljs-name">binder</span> flet cl<span class="hljs-symbol">:flet</span>)
  (<span class="hljs-name">binder</span> labels cl<span class="hljs-symbol">:labels</span>)
  (<span class="hljs-name">binder</span> macrolet cl<span class="hljs-symbol">:macrolet</span>)
  (<span class="hljs-name">binder</span> symbol-macrolet cl<span class="hljs-symbol">:symbol-macrolet</span>))

(<span class="hljs-name">defmacro</span> defun (<span class="hljs-name">name</span> args <span class="hljs-symbol">&amp;body</span> body)
  `(cl<span class="hljs-symbol">:defun</span> ,name ,args ,@body))

(<span class="hljs-name">defmacro</span> defsubst (<span class="hljs-name">name</span> args <span class="hljs-symbol">&amp;body</span> body)
  `(serapeum<span class="hljs-symbol">:defsubst</span> ,name ,args
     ,@body))

(<span class="hljs-name">defmacro</span> defalias (<span class="hljs-name">name</span> val)
  `(serapeum<span class="hljs-symbol">:defalias</span> ,name ,val))

(<span class="hljs-name">defmacro</span> def (<span class="hljs-name">var</span> expr) `(serapeum<span class="hljs-symbol">:def</span> ,var ,expr))
(<span class="hljs-name">defmacro</span> define-values (<span class="hljs-name">vars</span> expr) `(serapeum<span class="hljs-symbol">:define-values</span> ,vars ,expr))
(<span class="hljs-name">defmacro</span> defconst (<span class="hljs-name">var</span> expr) `(serapeum<span class="hljs-symbol">:defconst</span> ,var ,expr))
(<span class="hljs-name">defmacro</span> defconstant (<span class="hljs-name">var</span> expr) `(cl<span class="hljs-symbol">:defconstant</span> ,var ,expr))
(<span class="hljs-name">defmacro</span> define-symbol-macro (<span class="hljs-name">var</span> form) `(cl<span class="hljs-symbol">:define-symbol-macro</span> ,var ,form))

(<span class="hljs-name">defmacro</span> define-constant (<span class="hljs-name">name</span> init <span class="hljs-symbol">&amp;key</span> (<span class="hljs-name">test</span> ''eql) documentation)
  `(alexandria<span class="hljs-symbol">:define-constant</span> ,name ,init
     <span class="hljs-symbol">:test</span> ,test
     <span class="hljs-symbol">:documentation</span> ,documentation))

(<span class="hljs-name">deftype</span> cons (<span class="hljs-name">&amp;optional</span> x y)
  `(cl<span class="hljs-symbol">:cons</span> ,x ,y))

(<span class="hljs-name">defmacro</span> trivial-shadow (<span class="hljs-name">sym</span> args)
  (<span class="hljs-name">let*</span> ((<span class="hljs-name">name</span> (<span class="hljs-name">symbol-name</span> sym))
         (<span class="hljs-name">cl-sym</span> (<span class="hljs-name">find-symbol</span> name <span class="hljs-symbol">:cl</span>)))
    (<span class="hljs-name">unless</span> cl-sym
      (<span class="hljs-name">error</span> <span class="hljs-string">"No such symbol in CL: ~a"</span> name))
    `(defsubst ,sym ,args
       (,cl-sym ,@args))))

(<span class="hljs-name">defmacro</span> trivial-shadows (<span class="hljs-name">&amp;body</span> body)
  `(progn
     ,@(mapply (serapeum:op `(trivial-shadow ,_ ,_))
               (batches body <span class="hljs-number">2</span>))))

(<span class="hljs-name">trivial-shadows</span>
  cons (<span class="hljs-name">x</span> y)
  car (<span class="hljs-name">x</span>)
  cdr (<span class="hljs-name">x</span>)
  first (<span class="hljs-name">x</span>)
  rest (<span class="hljs-name">x</span>))

(<span class="hljs-name">deftype</span> list ()
  'cl<span class="hljs-symbol">:list</span>)

(<span class="hljs-name">defsubst</span> list (<span class="hljs-name">&amp;rest</span> args)
  (<span class="hljs-name">apply</span> #'cl<span class="hljs-symbol">:list</span> args))

(<span class="hljs-name">defsubst</span> list* (<span class="hljs-name">&amp;rest</span> args)
  (<span class="hljs-name">apply</span> #'cl<span class="hljs-symbol">:list*</span> args))

(<span class="hljs-name">defsubst</span> eval (<span class="hljs-name">form</span>)
  (<span class="hljs-name">cl</span><span class="hljs-symbol">:eval</span> form))

(<span class="hljs-name">defsubst</span> apply (<span class="hljs-name">function</span> <span class="hljs-symbol">&amp;rest</span> args)
  (<span class="hljs-name">cl</span><span class="hljs-symbol">:apply</span> #'cl<span class="hljs-symbol">:apply</span> function args))

(<span class="hljs-name">defsubst</span> funcall (<span class="hljs-name">function</span> <span class="hljs-symbol">&amp;rest</span> args)
  (<span class="hljs-name">cl</span><span class="hljs-symbol">:apply</span> #'cl<span class="hljs-symbol">:funcall</span> function args))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
