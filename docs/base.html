<!DOCTYPE html>

<html>
<head>
  <title>base.lisp</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="all.html">
                  all.lisp
                </a>
              
                
                <a class="source" href="base.html">
                  base.lisp
                </a>
              
                
                <a class="source" href="compile-to-file.html">
                  compile-to-file.lisp
                </a>
              
                
                <a class="source" href="file-package.html">
                  file-package.lisp
                </a>
              
                
                <a class="source" href="hash-lang.html">
                  hash-lang.lisp
                </a>
              
                
                <a class="source" href="hash-table-module.html">
                  hash-table-module.lisp
                </a>
              
                
                <a class="source" href="http.html">
                  http.lisp
                </a>
              
                
                <a class="source" href="impl.html">
                  impl.lisp
                </a>
              
                
                <a class="source" href="makefile.html">
                  makefile.lisp
                </a>
              
                
                <a class="source" href="module.html">
                  module.lisp
                </a>
              
                
                <a class="source" href="parsers.html">
                  parsers.lisp
                </a>
              
                
                <a class="source" href="safer-read.html">
                  safer-read.lisp
                </a>
              
                
                <a class="source" href="scripts.html">
                  scripts.lisp
                </a>
              
                
                <a class="source" href="shadows.html">
                  shadows.lisp
                </a>
              
                
                <a class="source" href="similarity.html">
                  similarity.lisp
                </a>
              
                
                <a class="source" href="simple-module.html">
                  simple-module.lisp
                </a>
              
                
                <a class="source" href="specials.html">
                  specials.lisp
                </a>
              
                
                <a class="source" href="types.html">
                  types.lisp
                </a>
              
                
                <a class="source" href="universal.html">
                  universal.lisp
                </a>
              
                
                <a class="source" href="util.html">
                  util.lisp
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>base.lisp</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>;;; The current base.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
(<span class="hljs-name">defpackage</span> <span class="hljs-symbol">:overlord/base</span>
  (<span class="hljs-symbol">:use</span> <span class="hljs-symbol">:cl</span> <span class="hljs-symbol">:alexandria</span> <span class="hljs-symbol">:serapeum</span>
    <span class="hljs-symbol">:overlord/types</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/specials</span>
    <span class="hljs-symbol">:*base*</span>
    <span class="hljs-symbol">:ensure-absolute</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:uiop</span>
    <span class="hljs-symbol">:pathname-directory-pathname</span>
    <span class="hljs-symbol">:absolute-pathname-p</span>
    <span class="hljs-symbol">:merge-pathnames*</span>)
  (<span class="hljs-symbol">:import-from</span> <span class="hljs-symbol">:overlord/util</span>
    <span class="hljs-symbol">:locate-dominating-file</span>)
  (<span class="hljs-symbol">:export</span>
   <span class="hljs-symbol">:*base*</span> <span class="hljs-symbol">:base</span>
   <span class="hljs-symbol">:set-package-base</span>
   <span class="hljs-symbol">:base-relative-pathname</span>
   <span class="hljs-symbol">:with-defaults-from-base</span>
   <span class="hljs-symbol">:hygienic-pathnames</span>
   <span class="hljs-symbol">:infer-system</span>))

(<span class="hljs-name">in-package</span> <span class="hljs-symbol">:overlord/base</span>)

(<span class="hljs-name">defmacro</span> with-defaults-from-base (<span class="hljs-name">&amp;body</span> body)
  <span class="hljs-string">"Wrapper for `call-with-defaults-from-base'."</span>
  `(let ((*default-pathname-defaults*
           (pathname-directory-pathname
            *base*)))
     ,@body))

(<span class="hljs-name">defvar</span> *package-bases* (<span class="hljs-name">make-hash-table</span>))

(<span class="hljs-name">defun</span> set-package-base* (<span class="hljs-name">base</span> <span class="hljs-symbol">&amp;optional</span> (<span class="hljs-name">system</span> <span class="hljs-literal">nil</span> system-supplied?))
  <span class="hljs-string">"Set the base for the current package.
If SYSTEM is supplied, use it with `asdf:system-relative-pathname' on BASE."</span>
  (<span class="hljs-name">setf</span> (<span class="hljs-name">gethash</span> *package* *package-bases*)
        (<span class="hljs-name">assure</span> (<span class="hljs-name">and</span> absolute-pathname directory-pathname)
          (<span class="hljs-name">if</span> system-supplied?
              (<span class="hljs-name">asdf</span><span class="hljs-symbol">:system-relative-pathname</span> system base)
              base))))

(<span class="hljs-name">defmacro</span> set-package-base (<span class="hljs-name">base</span> <span class="hljs-symbol">&amp;optional</span> (<span class="hljs-name">system</span> <span class="hljs-literal">nil</span> system-supplied?))
  `(eval-always
     (set-package-base* ,base
                        ,@(if system-supplied? (list system) <span class="hljs-literal">nil</span>))))

(<span class="hljs-name">defvar</span> *supplied-package-systems* (<span class="hljs-name">make-hash-table</span>))

(<span class="hljs-name">defun</span> base-relative-pathname (<span class="hljs-name">pathname</span>)
  (<span class="hljs-name">merge-pathnames</span> pathname (<span class="hljs-name">base</span>)))

(<span class="hljs-name">defun</span> base ()
  #+ () (<span class="hljs-name">or</span> *compile-file-truename*
            *load-truename*)
  (<span class="hljs-name">if</span> (<span class="hljs-name">boundp</span> '*base*) *base*
      (<span class="hljs-name">infer-base</span>)))

(<span class="hljs-name">defun</span> infer-base-1 (<span class="hljs-name">&amp;key</span> (<span class="hljs-name">errorp</span> <span class="hljs-literal">t</span>))
  (<span class="hljs-name">or</span> (<span class="hljs-name">gethash</span> *package* *package-bases*)
      (<span class="hljs-name">system-base</span> (<span class="hljs-name">infer-system</span> <span class="hljs-symbol">:errorp</span> errorp))))

(<span class="hljs-name">defun</span> infer-base (<span class="hljs-name">&amp;key</span> (<span class="hljs-name">errorp</span> <span class="hljs-literal">t</span>))
  (<span class="hljs-name">let</span> ((<span class="hljs-name">base</span> (<span class="hljs-name">infer-base-1</span> <span class="hljs-symbol">:errorp</span> errorp)))
    (<span class="hljs-name">if</span> (<span class="hljs-name">absolute-pathname-p</span> base)
        base
        (<span class="hljs-name">and</span> errorp
             (<span class="hljs-name">error*</span> <span class="hljs-string">"Cannot infer base.~%Package: ~a~%File: "</span>
                     *package*
                     (<span class="hljs-name">current-lisp-file</span>))))))

(<span class="hljs-name">defun</span> system-base (<span class="hljs-name">system</span>)
  (<span class="hljs-name">setf</span> system (<span class="hljs-name">asdf</span><span class="hljs-symbol">:find-system</span> system))
  (<span class="hljs-name">let</span> ((<span class="hljs-name">base</span> (<span class="hljs-name">asdf</span><span class="hljs-symbol">:system-relative-pathname</span> system <span class="hljs-string">""</span>)))
    (<span class="hljs-name">if</span> (<span class="hljs-name">absolute-pathname-p</span> base)
        base
        (<span class="hljs-name">if</span> (<span class="hljs-name">typep</span> system 'asdf<span class="hljs-symbol">:package-inferred-system</span>)
            (<span class="hljs-name">let*</span> ((<span class="hljs-name">system-name</span> (<span class="hljs-name">asdf</span><span class="hljs-symbol">:primary-system-name</span> system))
                   (<span class="hljs-name">base-system-name</span> (<span class="hljs-name">take-while</span> (<span class="hljs-name">op</span> (<span class="hljs-name">not</span> (<span class="hljs-name">eql</span> _ #\/))) system-name))
                   (<span class="hljs-name">base-system</span> (<span class="hljs-name">asdf</span><span class="hljs-symbol">:find-system</span> base-system-name)))
              (<span class="hljs-name">system-base</span> base-system))
            (<span class="hljs-name">error*</span> <span class="hljs-string">"System ~a has no base."</span> system)))))

(<span class="hljs-name">defun</span> infer-system (<span class="hljs-name">&amp;key</span> (<span class="hljs-name">errorp</span> <span class="hljs-literal">t</span>))
  (<span class="hljs-name">assure</span> (<span class="hljs-name">or</span> null asdf<span class="hljs-symbol">:system</span>)
    (<span class="hljs-name">or</span> (<span class="hljs-name">infer-system-from-package</span>)
        (<span class="hljs-name">look-for-asd</span>)
        (<span class="hljs-name">and</span> errorp
             (<span class="hljs-name">assure</span> asdf<span class="hljs-symbol">:system</span>
               (<span class="hljs-name">ensure2</span> (<span class="hljs-name">gethash</span> *package* *supplied-package-systems*)
                 (<span class="hljs-name">cerror*</span> <span class="hljs-string">"Supply a system name"</span>
                          <span class="hljs-string">"Cannot infer a system for ~a"</span> *package*)
                 (<span class="hljs-name">read-system-by-name</span>)))))))

(<span class="hljs-name">defun</span> read-system-by-name ()
  (<span class="hljs-name">format</span> <span class="hljs-literal">t</span> <span class="hljs-string">"~&amp;Type a system name: "</span>)
  (<span class="hljs-name">let</span> ((<span class="hljs-name">name</span> (<span class="hljs-name">make-keyword</span> (<span class="hljs-name">string</span> (<span class="hljs-name">read</span>)))))
    (<span class="hljs-name">or</span> (<span class="hljs-name">asdf</span><span class="hljs-symbol">:find-system</span> name <span class="hljs-literal">nil</span>)
        (<span class="hljs-name">progn</span>
          (<span class="hljs-name">cerror*</span> <span class="hljs-string">"Supply another name"</span>
                   <span class="hljs-string">"No such system as ~a"</span> name)
          (<span class="hljs-name">read-system-by-name</span>)))))

(<span class="hljs-name">defun</span> current-lisp-file ()
  (<span class="hljs-name">or</span> *compile-file-truename* *load-truename*))

(<span class="hljs-name">defun</span> infer-system-from-package ()
  (<span class="hljs-name">some</span> (<span class="hljs-name">lambda</span> (<span class="hljs-name">name</span>)
          (<span class="hljs-name">when-let</span> (<span class="hljs-name">guess</span> (<span class="hljs-name">package-name-system</span> name))
            (<span class="hljs-name">asdf</span><span class="hljs-symbol">:find-system</span> guess <span class="hljs-literal">nil</span>)))
        (<span class="hljs-name">package-names</span> *package*)))</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>;; XXX</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>(<span class="hljs-name">defun</span> package-name-system (<span class="hljs-name">n</span>)
  (<span class="hljs-name">asdf/package-inferred-system</span>:<span class="hljs-symbol">:package-name-system</span> n))

(<span class="hljs-name">defun</span> package-names (<span class="hljs-name">p</span>)
  (<span class="hljs-name">cons</span> (<span class="hljs-name">package-name</span> p)
        (<span class="hljs-name">package-nicknames</span> p)))

(<span class="hljs-name">defun</span> look-for-asd ()
  <span class="hljs-string">"Look for the nearest .asd file and return its name."</span>
  (<span class="hljs-name">and-let*</span> ((<span class="hljs-name">file</span> (<span class="hljs-name">current-lisp-file</span>))
             ((<span class="hljs-name">not</span> (<span class="hljs-name">typep</span> file 'temporary-file)))
             (.asd (<span class="hljs-name">nearest-asdf-file</span> file)))
    (<span class="hljs-name">asdf</span><span class="hljs-symbol">:find-system</span> (<span class="hljs-name">pathname-name</span> .asd) <span class="hljs-literal">nil</span>)))

(<span class="hljs-name">defun</span> nearest-asdf-file (<span class="hljs-name">file</span>)
  (<span class="hljs-name">locate-dominating-file</span> file <span class="hljs-string">"*.asd"</span>))

(<span class="hljs-name">defun</span> hygienic-pathnames (<span class="hljs-name">form</span> <span class="hljs-symbol">&amp;optional</span> (<span class="hljs-name">base</span> (<span class="hljs-name">base</span>)))
  (<span class="hljs-name">leaf-map</span> (<span class="hljs-name">lambda</span> (<span class="hljs-name">form</span>)
              (<span class="hljs-name">if</span> (<span class="hljs-name">typep</span> form 'relative-pathname)
                  (<span class="hljs-name">merge-pathnames*</span> form base)
                  form))
            form))</pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
